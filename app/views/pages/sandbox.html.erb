<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>embed tester</title>
  <style>
    html {
     box-sizing: border-box;
    }

    *, *:before, *:after {
      box-sizing: inherit;
    }

    * {
      padding: 0;
      margin: 0;
    }

    body {
      color: #333;
      font-family: 'Open Sans';
    }

    input[type=text] {
      padding: 2px 4px;
    }

    input#min-files {
      width: 30px;
    }
    .form-params {
      background-color: #bdc3c7;
      line-height: 3em;
      padding: 10px 20px;
    }

    .form-params .btn-render {
      background-color: #22313f;
      border-width: 0;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-family: 'Open Sans';
      padding: 6px 12px;
    }

    .form-params label {
      margin-left: 10px;
      margin-right: 2px;
    }

    .content {
      padding: 20px;
      width: 600px;
    }

    .viewer {
      clear: left;
      display: block;
      margin: 5px 0;
    }

    .xml-test {
      display: inline-block;
      margin-top: 10px;
      padding: 5px 10px;
    }

    .pass {
      background-color: #99C953;
    }

    .fail {
      background-color: #F16F44;
    }

  </style>

  <!--[if lt IE 9]>
  <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
</head>

<body>
  <form action="" class="form-params">
    <%= text_field_tag 'api-endpoint', "http://#{request.host}:#{request.port}#{embed_path}", class: 'api-endpoint', size: 50 %>/?url=
    <%= text_field_tag 'url-scheme', 'http://purl.stanford.edu/tn629pk3948', class:'url-scheme', size: 50 %>
    <label for="">&format=</label>
    <select name="select-format" id="select-format">
      <option value="json">JSON</option>
      <option value="xml">XML</option>
    </select>
    <label for="">&maxwidth=</label><input type="text" class="max-width" size="4" value="">
    <label for="">&maxheight=</label><input type="text" class="max-height" size="4" value="">
    <br>
    <label for="hide-title">Hide title?</label> <input type="checkbox" id="hide-title" class="hide-title" />
    <label for="hide-search">Hide search?</label> <input type="checkbox" id="hide-search" class="hide-search" />
    <label for="hide-search">Minimum files for search:</label> <input type="text" id="min-files" class="min-files" value="10" length="2" />
    <label for="hide-metadata">Hide metadata?</label> <input type="checkbox" id="hide-metadata" class="hide-metadata" />
    <label for="hide-embed">Hide embed?</label> <input type="checkbox" id="hide-embed" class="hide-embed" />
    <label for="hide-download">Hide download?</label> <input type="checkbox" id="hide-download" class="hide-download" />
    <br>
    <input type="button" class="btn-render" value="Embed">
    <br>
    <input type="checkbox" id="test-xml-response" class="test-xml-response" /><label for="hide-download">Test XML response</label>
  </form>

  <div class="content">
    <p>
      Nam sit amet mi ut lectus lobortis volutpat. Fusce bibendum sem quis odio feugiat, nec consectetur orci fermentum.
      Aliquam vel dignissim purus. Aliquam id urna ut nisl fermentum tempus et in odio. Donec varius interdum ex,
      sed finibus odio. Vivamus in sodales velit, non fermentum odio. Nunc in posuere lacus.
    </p>
    <div class="viewer"></div>
    <p>
      Proin vestibulum quam sed turpis blandit molestie. Ut a massa a est consequat semper vitae eu augue. Sed consequat
      euismod molestie. Vivamus tempus venenatis lorem nec facilisis. Mauris ultricies mauris felis. Maecenas efficitur
      sollicitudin sem non ullamcorper. Praesent auctor vehicula lorem id lobortis. Maecenas eu sapien eu massa facilisis
      lacinia eget eget eros. Duis in augue augue.
    </p>
    <h3>Useful Druids</h3>
    <ul>
      <li>
        Single image - sg052hd9120
      </li>
      <li>
        Multi image - fw090jw3474
      </li>
      <li>
        Files - tn629pk3948
      </li>
      <li>
        Warc-seed - http://sul-purl-test.stanford.edu/wb557fw1676
      </li>
    </ul>
  </div>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
  <script>
    $(function() {
      $('.btn-render').on('click', function() {
        embed.render();
      });
    });

    var embed = (function() {
      var $viewer = $('.viewer'),
          url, format, data;


      function init() {
        if (isValidUrl()) {
          submitRequest(url);

          if ($('.test-xml-response').is(':checked')) {
            checkXmlResponse(url);
          }
        };
      }


      function isValidUrl() {
        var apiEndpoint = $.trim($('.api-endpoint').val()),
            urlScheme = $.trim($('.url-scheme').val()),
            hideTitle = $('.hide-title').is(':checked'),
            hideSearch = $('.hide-search').is(':checked'),
            minFiles = $('.min-files').val(),
            hideMetadata = $('.hide-metadata').is(':checked'),
            hideEmbed = $('.hide-embed').is(':checked'),
            hideDownload = $('.hide-download').is(':checked'),
            maxWidth = parseInt($('.max-width').val(), 10),
            maxHeight = parseInt($('.max-height').val(), 10);

        format = $('#select-format').val();

        if (apiEndpoint !== "" && urlScheme !== "") {
          url = apiEndpoint + "/?url=" + urlScheme + "&format=" + format;

          if (hideTitle) url += "&hide_title=true";
          if (hideSearch) url += "&hide_search=true";
          if (minFiles) url += "&min_files_to_search=" + minFiles;
          if (hideMetadata) url += "&hide_metadata=true";
          if (hideEmbed) url += "&hide_embed=true";
          if (hideDownload) url += "&hide_download=true";
          if (!isNaN(maxWidth)) url += "&maxwidth=" + maxWidth;
          if (!isNaN(maxHeight)) url += "&maxheight=" + maxHeight;

        } else {
          alert('Error:\nEmpty API endpoint and/or URL scheme')
          return false;
        }

        return true;
      }


      function updatePage(response, xmlTest) {
        var xmlDoc, width, height,
            html = '',
            $test = $('<p class="xml-test fail">XML response check : </p>'),
            $icon = $('<span style="margin-left: 5px;">&#x2718;</span>');

        if (format === "json") {
          html   = response.html;
          width  = response.width;
          height = response.height;
        }

        if (format === "xml") {
          xmlDoc = $(response);
          html   = $(xmlDoc.find('html').text());
          width  = xmlDoc.find('width').text();
          height = xmlDoc.find('height').text();
        }

        $viewer.empty().append(html);

        if (xmlTest) {
          if (xmlDoc && html !== '') {
            $test.removeClass('fail').addClass('pass');
            $icon.html(' &#x2714;');
          }

          $viewer.append($test.append($icon));
        }
      }


      function submitRequest(url, xmlTest) {
        var request = $.ajax({
          type: "GET",
          url: url,
          dataType: format
        });

        request.success(function(response) {
          updatePage(response, xmlTest);
        });

        request.fail(function(jqXhr, status) {
          console.log('Request failed : ' + status);
        });
      }


      function checkXmlResponse(url) {
        url = url.replace('format=json', 'format=xml');
        format = 'xml';
        submitRequest(url, true);
      }


      return {
        render: function() {
          init();
        }
      };

    })();
  </script>
</body>

</html>
